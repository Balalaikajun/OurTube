# OurTube.backend

## Введение

Данный проект разрабатывался студентом 3 курса, в качестве курсового проекта.

На момент начала разработки опыт работы с C# был около года, с Asp.Net - пара месяцев.

## Api и функционал

В данном проекте было реализовано API, предоставляющее весь базовый функционал видеохостинга, а именно:

- Регистрация и авторизация пользователей
- Загрузка и просмотр видео
- Комментарии к видео
- Плейлисты
- Реакции (лайки/дизлайки) для видео и комментариев
- История просмотров
- Рекомендации

Подробнее ознакомиться с Api вы можете по ссылке [OpenApi](https://balalaikajun.github.io/OurTube/).

## Стек технологий

При разработке были использованы следующие инструменты:

- **ASP.NET 9.0**:
    - **AspNetCore.Identity** - авторизация, аутентификация и т.д.
    - **EntityFramework Core** - ORM
    - **AutoMapper** - маппинг
    - **MediatR** - работа с событиями
    - **Minio SDK** - SDK для работы с Minio
    - **MailKit** - работа с электронной почтой
    - **Xabe.FFmpeg** - работа с FFmpeg
- **PostgreSQL** - база данных
- **Minio** - хранилище файлов
- **FFmpeg** - обработка видео
- **Nginx** - веб-сервер, обратный прокси
- **Docker/Docker Compose** - развёртывание
- **Git/GitHub** - система контроля версий
- **VisualStudio/JetBrains Rider, Webstorm** - IDE

## Архитектура

### Сервер

Проект сервера представляет из себя обычный монолит, построенный с использованием принципов чистой архитектуры, где
каждый слой выделен в отдельный проект.
На рисунке изображены пространства имён разбитые по слоям-проектам.
<img src="attachments/Layers.png" alt="Скриншот" width="350"/>

В таблице приведено описание пространств имён из схемы

| Название                  | Описание содержимого                                                             |
|---------------------------|----------------------------------------------------------------------------------|
| Controllers               | Контроллеры приложения, обрабатывающие запросы                                   |
| Middlwares                | Middleware – обработчики запросов, срабатывающие между их принятием и обработкой |
| Attributes                | Кастомные атрибуты                                                               |
| Utils                     | Прочий код для настройки Api                                                     |
| Interfaces (Application)  | Контракты приложения (Интерфейсы)                                                |
| Services (Application)    | Сервисы – сборники различного функционала                                        |
| Requests                  | Запросы для Api / Сервисов                                                       |
| Replies                   | Ответы Api / Сервисов                                                            |
| Mappings                  | Конфигурации маппинга                                                            |
| Handlers                  | Обработчики ивентов для библиотеки MediatR                                       |
| Extensions                | Методы расширения для выполнения различных работ                                 |
| Validators                | Логика валидации (проверки) данных                                               |
| Entities                  | Сущности, описывающие предметную область приложения                              |
| Interfaces (Domain)       | Контракты для сущностей                                                          |
| Events                    | Доменные ивенты MediatR                                                          |
| Exceptions                | Кастомные исключения                                                             |
| Services (Infrastructure) | Сервисы, работающие с внешними элементами                                        |
| Data                      | Настройки ORM                                                                    |
| Migrations                | Миграции EntityFramework                                                         |

### База данных

На рисунке изображена схема базы данных
<img src="attachments/PostgreSQL.png" alt="Скриншот"/>
В таблице приведён перечень таблиц и их назначение

| Название                                                                                                           | Описание содержимого                                                                                     |
|--------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------|
| ApplicationUser                                                                                                    | Таблица, содержащая данные пользователя, необходимые для работы бизнес-логики приложения                 |
| Subscriptions                                                                                                      | Подписки пользователей                                                                                   |
| UserAvatar                                                                                                         | Данные об аватарах и их расположении в хранилище                                                         |
| Videos                                                                                                             | Метаданные видео, необходимые для работы логики приложения                                               |
| VideoSource                                                                                                        | Данные об исходниках видео и их расположении в хранилище                                                 |
| VideoPreview                                                                                                       | Данные о превью-изображениях видео и их расположении в хранилище                                         |
| VideoPlaylist                                                                                                      | Данные о плейлистах формата `.m3u8`, необходимых для работы стандарта HLS, и их расположении в хранилище |
| Tags                                                                                                               | Список тегов, существующих в системе                                                                     |
| VideoTags                                                                                                          | Связь «многие-ко-многим» между видео и тегами                                                            |
| VideoVotes                                                                                                         | Данные о реакциях пользователя на видео (лайк/дизлайк)                                                   |
| VideoView                                                                                                          | История просмотров                                                                                       |
| Playlists                                                                                                          | Данные о пользовательских плейлистах                                                                     |
| PlaylistElements                                                                                                   | Связь «многие-ко-многим» между плейлистами пользователей и видео                                         |
| Comments                                                                                                           | Комментарии пользователей                                                                                |
| CommentVotes                                                                                                       | Реакции на комментарии                                                                                   |
| IdentityUser, AspNetUserClaims, AspNetUserLogins, AspNetUserTokens, AspNetUserRoles, AspNetRoleClaims, AspNetRoles | Таблицы для работы библиотеки ASP.NET Identity                                                           |
| __EFMigrationsHistory                                                                                              | Системная таблица EF Core                                                                                |

### Хранилище файлов
В таблице приведена структура путей в хранилище 

| Описание             | Bucket | Путь                                               |
|----------------------|--------|----------------------------------------------------|
| Исходник видео       | videos | `{GUID-Видео}/source.mp4`                          |
| Превью изображение   | videos | `{GUID-Видео}/preview.jpg`                         |
| Плейлист HLS         | videos | `{GUID-Видео}/{Resolution}/playlist.m3u8`          |
| Сегмент HLS          | videos | `{GUID-Видео}/{Resolution}/segments/segment_{№}.ts`|
| Аватар пользователя  | users  | `{UserId}/avatar.jpg`                              |

## Развёртывание

## Итоги

Общие итоги

### Интересные моменты

### Недоработки

### Улучшения

### План в случае продолжения разработки