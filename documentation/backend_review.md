# OurTube.backend. Рефлексия и подведение итогов

## Введение

Здесь подведены итоги разработки серверной части видеохостинга: принятые решения, найденные проблемы и предложения по
дальнейшему развитию.

Описание нынешней реализации - [backend.md](backend.md).

### Предисловие

На старте у команды был небольшой опыт: ~1.5 года в C# и около двух месяцев в ASP.NET. Проект выполняли двое студентов в
течение ~6 месяцев с перерывом в 2 месяца. Цель — реализовать MVP видеохостинга, сосредоточившись на технической части
системы (архитектура, хранение и обработка видео), а не на глубокой бизнес-логике.

## Решения, реализации и интересные моменты

### Архитектура решения

На момент старта разработки знания были очень сильно ограничены. Было желание с самого начала попробовать реализовать
микросервисы, но по итогу остановились на монолите с элементами чистой архитектуры. Что значительно упростило процесс
разработки.
Такой подход показал себя хорошо для мелко-среднего проекта.

### Использование элементов DDD и событий

В приложении выделен доменный слой, в начале разработки он был достаточно простым. Затем где-то в середине разработки
возникла потребность в структурированной обработке связанной логики. Для решения данной проблемы внедрили доменные
события в определённых местах, вследствие чего в домене появилась первая базовая модель.

Уже ближе к концу разработки, после как появился опыт работы над реальными проектами, для решения ряда проблем было
принято решение пересобрать домен, что повлекло за собой ряд изменений:

- Базовая модель была доработана
    - Был введён Guid в качестве идентификатора
    - Был введён базовый вариант SoftDelete
    - Появились стандартные поля для аудита
- Базовая модель была применена ко всему домену, что упростило код и позволило применять продвинутые приёмы

DDD показал свою пользу: код стал чище и понятнее. При этом остаются пробелы — например, все сущности используют одну
базу данных, что местами избыточно.

### ASP.Identity

Использована встроенная система ASP.NET Identity. Библиотека оказалась не «готовым решением», а набором инструментов —
её нужно конфигурировать и дополнять. Понимание этого пришло достаточно поздно и к сожалению, в рамках проекта так и не
дошли руки до нормального её использования, из-за чего вся identity реализована поверхностно.

В общем: "Хотели рыбу, дали удочку".

### Рекомендации

Реализация системы рекомендаций стала одним из двух камней преткновения в данном проекте.
Полноценная работа над ней начиналась во второй половине разработки. Было принято идти по самому простому варианту и
сделать алгоритм, основанный на простой выборке лишь бы работал.

Итоговое решение работает за счёт комбинации нескольких более мелких выборок, работающих за счёт подсчёта весов для
видео, и последующим кешированием на стороне сервера, для избежания повторения.

### Requests/Replies и проброс сообщений меж слоёв

Изначально использовались DTO, затем введена модель запросов/ответов (Requests/Replies). Однако DTO были частично
переиспользованы между слоями, что привело к смешению контрактов и затруднило изоляцию слоёв. Это мешает полностью
реализовать преимущества четких API/контрактов между слоями.

Пример проблемного контракта сервиса:

```csharp
  Task<ListReply<MinVideo>> SearchVideos(Guid? userId, Guid sessionId, PaginationQueryParametersWithSearch parameters);
```

Лучше разделять API DTO и внутренние контракты application-слоя.

### UnitOfWork над ORM

В самом начале разработки, в попытках разобраться в том как должен правильно выглядеть подобный проект мы узнали о такой
прекрасной вещи как паттерн "репозиторий", а так же "UnitOfWork", и мы конечно же захотели его использовать.

На практике это усложнило разработку и ограничило возможности ORM. Впоследствии было решено отказаться от данного
подхода. В данном случае данное решение было мягко сказать избыточным, но как опыт достаточно интересно.

### Развёртывание

Развёртывание проекта оказалось одним из сложных моментов в разработке, в большей степени из-за того что делалось по
наитию, стремясь сделать правильно, не понимая что такое правильно. Но всё же после какого то количества проб и ошибок,
получилось прийти к варианту, который позволяет достаточно легко развернуть различные варианты проекта,
подробнее - [deployment.md](deployment.md).

## Недоработки

### Валидация и обработка ошибок

К концу разработки появились кастомные исключения и первые попытки в системную обработку ошибок. Однако валидация
остаётся разбросанной: часть логики в сервисах, часть — в атрибутах и вспомогательных классах. Требуется
систематизировать валидацию и обработку исключений.

### Модерация

Вторым и наверняка главным камнем преткновения к концу разработки стала модерация. Был серьёзный страх того что если её
не будет даже номинально, то при запуске проект максимально быстро наполниться материалами интересного содержания.

Предлагалось два варианта решения данной задачи:

1. Автоматизированная модерация с помощью ML-сервисов (сторонние API).
2. Полуавтоматизированная модерация: асинхронная обработка видео + интерфейс проверки (mini-студия, телеграм-бот).

Оба варианта требуют времени. В рамках MVP реализована ни одна из этих систем модерация не была реализована.

### Тестирование

Тестирование полностью опущено. Наличие unit и integration тестов могло бы сэкономить время и снизить риски при
рефакторинге.

## Возможные улучшения

### Переход на асинхронную обработку видео

На данный момент процесс загрузки видео полностью синхронный, что создаёт узкое место. В дальнейшем стоит перейти на
асинхронный вариант обработки.

### Проработка Identity и внедрение системы ролей

Как упоминалось выше, на данный момент все элементы identity в проекте реализованы максимально поверхностно.
Вместе с тем хорошей реализации модерации, было бы хорошо иметь проработанную систему ролей.

### Теоретический переход на микросервисную архитектуру и прочие кардинальные изменения

мере развития проекта можно рассматривать разделение на сервисы, более глубокое применение DDD, CQRS и т.п., но только
после устранения ключевых проблем (видео-pipeline, модерация, Identity).

## В случае продолжения разработки

На основе всего вышесказанного можно вывести список основных проблем решения:

1. Отсутствие модерации
2. Полупустая Identity
3. Определённое количество недоработок в архитектуре решения, будь то недоработанная структура Request\Replies или
   элементы DDD
4. Слабый алгоритм рекомендаций
5. Синхронная обработка видео
6. И прочие более мелкие, но важные недочёты

Для продолжения разработки рекомендуется провести аудит архитектуры и составить план действий, приоритетно решая
перечисленные пункты под лозунгом: "Не расширяй, а улучшай!".

## Итоги

Проект достиг целей MVP: реализованы загрузка/просмотр видео, комментарии, плейлисты, базовые реакции и рекомендации.
При этом остались критичные для масштабирования и эксплуатации вопросы: обработка видео, модерация, Identity и
тестирование. Для команды проект стал хорошей практикой и дал много опыта, но на данный момент дальнейшая разработка не
планируется.

Спасибо за прочтение.